home-assistant:
  hostNetwork: true
  dnsPolicy: ClusterFirstWithHostNet
  ingress:
    main:
      enabled: true
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
        hajimari.io/appName: Home-Assistant
        hajimari.io/icon: google-drive
        nginx.org/websocket-services: home-assistant
        external-dns.alpha.kubernetes.io/target: "homelab-tunnel.danger250.com"
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
      hosts:
        - host: &host home-assistant.danger250.com
          paths:
            - path: /
              pathType: Prefix
      tls:
        - secretName: home-assistant-tls-certificate
          hosts:
            - *host
  lifecycle:
    preStop:
      exec:
        command:
          - "/bin/sh"
          - "-c"
          - cp -f configuration.yaml_new configuration.yaml;
            wget -O - https://get.hacs.xyz | bash -;
            if [ ! -d ./media ]; then
            mkdir media;
            fi;
            if [ ! -d ./www ]; then
            mkdir www;
            fi;
  persistence:
    config:
      enabled: true
      size: 2Gi
      storageClass: rook-ceph-block
    configfile:
      enabled: true
      name: home-assistant-configfile
      items:
        - key: configuration
          path: configuration.yaml_new
      type: configMap
      mountPath:  /config/configuration.yaml_new
      subPath: configuration.yaml_new
  configmap:
    configfile:
      enabled: true
      data:
        configuration: |
          # Loads default set of integrations. Do not remove.
          default_config:

          # Load frontend themes from the themes folder
          frontend:
            themes: !include_dir_merge_named themes

          http:
            server_host: 0.0.0.0
            ip_ban_enabled: true
            login_attempts_threshold: 5
            use_x_forwarded_for: true
            trusted_proxies:
              - 10.42.0.0/16
              - 192.168.1.0/24
  addons:
    codeserver:
      enabled: true
      args:
        - --auth
        - none
        - --user-data-dir
        - /data/config/.vscode
      volumeMounts:
        - name: config
          mountPath: /data/config